<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio/Video Editor PRO - Web</title>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            gap: 20px;
        }
        
        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border-radius: 12px;
        }
        
        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #58a6ff;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 12px 24px;
            background-color: #238636;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn:hover {
            background-color: #2ea043;
        }
        
        .btn-secondary {
            background-color: #21262d;
            color: #c9d1d9;
        }
        
        .btn-secondary:hover {
            background-color: #30363d;
        }
        
        /* Hidden file input */
        #fileInput {
            display: none;
        }
        
        /* STATUS */
        .status-bar {
            padding: 15px 20px;
            background-color: #161b22;
            border-radius: 10px;
            border: 1px solid #30363d;
        }
        
        .status-main {
            font-size: 1.1rem;
            color: #c9d1d9;
            margin-bottom: 8px;
        }
        
        .status-selection {
            font-size: 1rem;
            color: #58a6ff;
            font-weight: 500;
        }
        
        /* TIMELINE */
        .timeline-container {
            padding: 25px;
            background-color: #161b22;
            border-radius: 12px;
            border: 1px solid #30363d;
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        .time-current {
            color: #f85149;
        }
        
        .time-selection {
            color: #58a6ff;
        }
        
        .time-total {
            color: #8b949e;
        }
        
        .timeline-track {
            position: relative;
            height: 80px;
            background-color: #0d1117;
            border-radius: 10px;
            border: 2px solid #21262d;
            cursor: pointer;
        }
        
        .timeline-cursor {
            position: absolute;
            width: 4px;
            height: 100%;
            background-color: #f85149;
            top: 0;
            z-index: 10;
            box-shadow: 0 0 15px rgba(248, 81, 73, 0.7);
        }
        
        /* TRACKS */
        .tracks-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #161b22;
            border-radius: 12px;
            border: 1px solid #30363d;
        }
        
        .tracks-empty {
            text-align: center;
            color: #8b949e;
            padding: 60px;
            font-size: 1.3rem;
        }
        
        .track-item {
            background-color: #0d1117;
            border: 3px solid #21262d;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .track-item:hover {
            border-color: #30363d;
        }
        
        .track-item.selected {
            border-color: #f0883e;
            background-color: #1c2128;
            box-shadow: 0 0 0 4px rgba(240, 136, 62, 0.15);
        }
        
        .track-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #c9d1d9;
            margin-bottom: 20px;
        }
        
        .track-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .track-info-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .track-info-label {
            color: #6e7681;
            font-weight: 500;
        }
        
        .track-info-value {
            color: #c9d1d9;
            font-weight: 700;
        }
        
        .track-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .track-btn {
            padding: 8px 16px;
            background-color: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .track-btn:hover {
            background-color: #30363d;
        }
        
        /* Progress */
        .progress-container {
            margin-top: 15px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #21262d;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #238636;
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            color: #8b949e;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        /* Dialogs */
        dialog {
            background-color: #161b22;
            color: #c9d1d9;
            border: 2px solid #30363d;
            border-radius: 12px;
            padding: 30px;
            min-width: 400px;
        }
        
        dialog h2 {
            color: #58a6ff;
            margin-bottom: 20px;
        }
        
        dialog button, dialog select, dialog input {
            padding: 12px 20px;
            background-color: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            border-radius: 8px;
            font-size: 1rem;
            margin: 5px;
            cursor: pointer;
        }
        
        dialog input[type="text"],
        dialog input[type="number"] {
            background-color: #0d1117;
            width: 100%;
        }
        
        dialog select {
            width: 100%;
        }
        
        .sr-only {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
        
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: #0d1117;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
    </style>
</head>
<body>
    <div id="statusAnnouncer" role="status" aria-live="polite" aria-atomic="true" class="sr-only"></div>
    
    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <h1>Audio/Video Editor PRO</h1>
            <div class="header-buttons">
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    Carica File
                </button>
                <button class="btn-secondary btn" onclick="document.getElementById('helpDialog').showModal()">
                    Aiuto
                </button>
            </div>
        </div>
        
        <!-- Hidden file input -->
        <input type="file" id="fileInput" accept="audio/*,video/*" multiple>
        
        <!-- STATUS -->
        <div class="status-bar">
            <div class="status-main" id="statusText">Carica un file per iniziare</div>
            <div class="status-selection" id="selectionInfo"></div>
        </div>
        
        <!-- TIMELINE -->
        <div class="timeline-container">
            <div class="timeline-header">
                <span class="time-current" id="currentTime">00:00.000</span>
                <span class="time-selection" id="selectionLength"></span>
                <span class="time-total" id="duration">00:00.000</span>
            </div>
            <div class="timeline-track" id="timelineTrack">
                <div class="timeline-cursor" id="timelineCursor" style="left: 0%;"></div>
            </div>
        </div>
        
        <!-- TRACKS -->
        <div class="tracks-container" id="tracksSection">
            <div class="tracks-empty">Nessuna traccia<br>Clicca "Carica File" per iniziare</div>
        </div>
    </div>
    
    <!-- DIALOGS -->
    <dialog id="effectsDialog">
        <h2>Effetti Audio</h2>
        <div id="effectsContent"></div>
        <div style="margin-top: 25px;">
            <button class="btn" onclick="app.applyEffects()">Applica</button>
            <button class="btn-secondary" onclick="document.getElementById('effectsDialog').close()">Annulla</button>
        </div>
    </dialog>
    
    <dialog id="convertDialog">
        <h2>Converti Formato</h2>
        <p style="margin-bottom: 20px;">File: <strong id="convertFileName"></strong></p>
        
        <!-- Opzione Audio to Video -->
        <div id="audioToVideoOption" style="display: none; margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px;">
                <strong>Modalità conversione:</strong>
            </label>
            <select id="audioToVideoMode" onchange="app.updateConvertOptions()" 
                    style="width: 100%; padding: 10px; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                <option value="none">Conversione normale</option>
                <option value="static">Video con immagine statica</option>
                <option value="slideshow">Video slideshow (più immagini)</option>
                <option value="background">Video con video background</option>
            </select>
        </div>
        
        <!-- Upload immagine/i -->
        <div id="imageUploadSection" style="display: none; margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px;">
                <strong>Seleziona immagine/i:</strong>
            </label>
            <input type="file" id="imageFileInput" accept="image/*" 
                   style="width: 100%; padding: 10px; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
            <small style="color: #8b949e; display: block; margin-top: 5px;">
                Formati: JPG, PNG, GIF, WebP
            </small>
            
            <!-- Opzioni slideshow -->
            <div id="slideshowOptions" style="display: none; margin-top: 15px; padding: 15px; background-color: #161b22; border-radius: 8px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <strong>Durata per immagine (secondi):</strong>
                    </label>
                    <input type="number" id="imageDuration" min="1" max="30" value="5" step="0.5"
                           style="width: 100%; padding: 8px; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <strong>Tipo di transizione:</strong>
                    </label>
                    <select id="transitionType" 
                            style="width: 100%; padding: 8px; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                        <option value="fade">Dissolvenza (Fade)</option>
                        <option value="none">Nessuna transizione (Cut)</option>
                    </select>
                </div>
                
                <small style="color: #8b949e;">
                    Se le immagini non coprono tutta la durata, l'ultima verrà estesa.
                </small>
            </div>
        </div>
        
        <!-- Upload video -->
        <div id="videoUploadSection" style="display: none; margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px;">
                <strong>Seleziona video:</strong>
            </label>
            <input type="file" id="videoFileInput" accept="video/*" multiple
                   style="width: 100%; padding: 10px; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
            <small style="color: #8b949e; display: block; margin-top: 5px;">
                Formati: MP4, MKV, AVI, MOV, WebM (puoi selezionare più video)
            </small>
            
            <!-- Opzioni video merge -->
            <div id="videoMergeOptions" style="display: none; margin-top: 15px; padding: 15px; background-color: #161b22; border-radius: 8px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <strong>Gestione durata:</strong>
                    </label>
                    <select id="videoMergeMode" 
                            style="width: 100%; padding: 8px; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                        <option value="loop">Loop video (ripeti fino a fine audio)</option>
                        <option value="cut">Taglia al più corto</option>
                        <option value="extend">Rallenta video per matchare audio</option>
                    </select>
                </div>
                
                <small style="color: #8b949e;">
                    <strong>Loop:</strong> Il video si ripete finché non finisce l'audio<br>
                    <strong>Taglia:</strong> Termina quando finisce audio o video (il più corto)<br>
                    <strong>Rallenta:</strong> Il video viene rallentato per durare quanto l'audio
                </small>
            </div>
        </div>
        
        <!-- Selezione formato -->
        <label style="display: block; margin-bottom: 10px;">
            <strong>Formato output:</strong>
        </label>
        <select id="convertFormat" style="margin-bottom: 20px; width: 100%; padding: 10px; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
            <optgroup label="AUDIO">
                <option value="mp3">MP3</option>
                <option value="wav">WAV</option>
                <option value="flac">FLAC</option>
                <option value="m4a">M4A</option>
            </optgroup>
            <optgroup label="VIDEO">
                <option value="mp4">MP4</option>
                <option value="mkv">MKV</option>
                <option value="avi">AVI</option>
                <option value="mov">MOV</option>
            </optgroup>
        </select>
        
        <div style="margin-top: 25px;">
            <button class="btn" onclick="app.convertFile()">Converti</button>
            <button class="btn-secondary" onclick="document.getElementById('convertDialog').close()">Annulla</button>
        </div>
    </dialog>
    
    <dialog id="helpDialog">
        <h2>Guida Rapida</h2>
        <div style="line-height: 2;">
            <p><strong>Carica File:</strong> Clicca "Carica File" o trascina file nella pagina</p>
            <p><strong>Effetti:</strong> Seleziona traccia, poi clicca "Effetti"</p>
            <p><strong>Converti:</strong> Clicca "Converti" per cambiare formato</p>
            <p><strong>Download:</strong> Dopo il processamento, clicca "Download"</p>
        </div>
        <button class="btn" onclick="document.getElementById('helpDialog').close()" style="margin-top: 25px;">Chiudi</button>
    </dialog>
    
    <script>
// Configurazione API
const API_URL = 'http://138.199.196.24/api'; //  IL TUO IP

class VideoEditorWeb {
    constructor() {
        this.tracks = [];
        this.selectedTrackId = null;
        this.cursorPosition = 0;
        this.init();
    }

    init() {
        console.log(' Video Editor Web inizializzato');
        this.setupEventListeners();
        this.updateDisplay();
    }

    setupEventListeners() {
        // File input
        document.getElementById('fileInput').addEventListener('change', (e) => {
            this.handleFileUpload(e.target.files);
        });

        // Timeline click
        document.getElementById('timelineTrack').addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            const maxDuration = Math.max(...this.tracks.map(t => t.duration || 0), 300);
            this.cursorPosition = percent * maxDuration;
            this.updateDisplay();
        });

        // Drag & Drop
        document.body.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        document.body.addEventListener('drop', (e) => {
            e.preventDefault();
            this.handleFileUpload(e.dataTransfer.files);
        });
    }

    async handleFileUpload(files) {
        for (const file of files) {
            await this.uploadFile(file);
        }
    }

    async uploadFile(file) {
        try {
            this.updateStatus(` Upload ${file.name}...`);

            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch(`${API_URL}/upload`, {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                throw new Error('Upload fallito');
            }

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Upload fallito');
            }

            // Crea traccia
            const track = {
                id: data.fileId,
                name: data.originalName,
                filePath: data.filePath,
                size: data.size,
                duration: data.duration || 0,
                type: this.getFileType(data.originalName),
                volume: 1.0,
                effects: {},
            };

            this.tracks.push(track);
            this.updateStatus(` ${file.name} caricato!`);
            this.renderTracks();

        } catch (error) {
            this.updateStatus(` Errore: ${error.message}`, true);
            console.error('Upload error:', error);
        }
    }

    getFileType(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const audioExts = ['mp3', 'wav', 'ogg', 'm4a', 'flac', 'aac'];
        return audioExts.includes(ext) ? 'audio' : 'video';
    }

    renderTracks() {
        const container = document.getElementById('tracksSection');
        
        if (this.tracks.length === 0) {
            container.innerHTML = '<div class="tracks-empty">Nessuna traccia<br>Clicca "Carica File" per iniziare</div>';
            return;
        }

        container.innerHTML = this.tracks.map((track, index) => `
            <div class="track-item ${this.selectedTrackId === track.id ? 'selected' : ''}" 
                 onclick="app.selectTrack('${track.id}')">
                <div class="track-name">${track.type === 'audio' ? '' : ''} ${track.name}</div>
                
                <div class="track-info">
                    <div class="track-info-row">
                        <span class="track-info-label">Tipo:</span>
                        <span class="track-info-value">${track.type.toUpperCase()}</span>
                    </div>
                    <div class="track-info-row">
                        <span class="track-info-label">Durata:</span>
                        <span class="track-info-value">${this.formatTime(track.duration)}</span>
                    </div>
                    <div class="track-info-row">
                        <span class="track-info-label">Dimensione:</span>
                        <span class="track-info-value">${this.formatBytes(track.size)}</span>
                    </div>
                    <div class="track-info-row">
                        <span class="track-info-label">Volume:</span>
                        <span class="track-info-value">${Math.round(track.volume * 100)}%</span>
                    </div>
                </div>
                
                <div class="track-actions">
                    ${track.type === 'audio' ? `
                        <button class="track-btn" onclick="event.stopPropagation(); app.openEffects('${track.id}')">
                             Effetti
                        </button>
                    ` : ''}
                    <button class="track-btn" onclick="event.stopPropagation(); app.openConvert('${track.id}')">
                         Converti
                    </button>
                    <button class="track-btn" onclick="event.stopPropagation(); app.deleteTrack('${track.id}')">
                        Elimina
                    </button>
                </div>
                
                <div class="progress-container" id="progress-${track.id}">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill-${track.id}"></div>
                    </div>
                    <div class="progress-text" id="progress-text-${track.id}"></div>
                </div>
            </div>
        `).join('');

        this.updateDisplay();
    }

    selectTrack(trackId) {
        this.selectedTrackId = trackId;
        this.renderTracks();
    }

    deleteTrack(trackId) {
        if (confirm('Eliminare questa traccia?')) {
            const track = this.tracks.find(t => t.id === trackId);
            
            if (track && track.filePath) {
                fetch(`${API_URL}/file/${encodeURIComponent(track.filePath)}`, {
                    method: 'DELETE',
                }).catch(e => console.warn('Errore eliminazione:', e));
            }

            this.tracks = this.tracks.filter(t => t.id !== trackId);
            if (this.selectedTrackId === trackId) {
                this.selectedTrackId = null;
            }
            this.renderTracks();
        }
    }

    openEffects(trackId) {
        const track = this.tracks.find(t => t.id === trackId);
        if (!track) return;

        this.selectedTrackId = trackId;

        const dialog = document.getElementById('effectsDialog');
        const content = document.getElementById('effectsContent');

        content.innerHTML = `
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">Volume (${Math.round((track.effects.volume || 1.0) * 100)}%)</label>
                <input type="range" id="effect-volume" min="0" max="200" value="${(track.effects.volume || 1.0) * 100}" 
                       oninput="this.nextElementSibling.textContent = this.value + '%'">
                <span>${Math.round((track.effects.volume || 1.0) * 100)}%</span>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label>
                    <input type="checkbox" id="effect-normalize" ${track.effects.normalize ? 'checked' : ''}>
                    Normalizza Audio
                </label>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label>
                    <input type="checkbox" id="effect-bassboost" ${track.effects.bassBoost ? 'checked' : ''}>
                    Bass Boost
                </label>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label>
                    <input type="checkbox" id="effect-echo" ${track.effects.echo ? 'checked' : ''}>
                    Echo
                </label>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">Fade In (secondi)</label>
                <input type="number" id="effect-fadein" min="0" max="10" step="0.5" 
                       value="${track.effects.fadeIn || 0}" style="width: 100%;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">Fade Out (secondi)</label>
                <input type="number" id="effect-fadeout" min="0" max="10" step="0.5" 
                       value="${track.effects.fadeOut || 0}" style="width: 100%;">
            </div>
        `;

        dialog.showModal();
    }

    async applyEffects() {
        const track = this.tracks.find(t => t.id === this.selectedTrackId);
        if (!track) return;

        const effects = {
            volume: parseFloat(document.getElementById('effect-volume').value) / 100,
            normalize: document.getElementById('effect-normalize').checked,
            bassBoost: document.getElementById('effect-bassboost').checked,
            echo: document.getElementById('effect-echo').checked,
            fadeIn: parseFloat(document.getElementById('effect-fadein').value) || 0,
            fadeOut: parseFloat(document.getElementById('effect-fadeout').value) || 0,
            fadeOutStart: track.duration - (parseFloat(document.getElementById('effect-fadeout').value) || 0),
        };

        document.getElementById('effectsDialog').close();

        try {
            this.showProgress(track.id, 'Applicazione effetti...');

            const response = await fetch(`${API_URL}/audio-effects`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filePath: track.filePath,
                    effects,
                }),
            });

            if (!response.ok) throw new Error('Processamento fallito');

            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            track.effects = effects;
            track.processedId = data.outputId;

            this.hideProgress(track.id);
            this.updateStatus(' Effetti applicati! Scarico file...');

            this.downloadFile(data.outputId, track.name);

        } catch (error) {
            this.hideProgress(track.id);
            this.updateStatus(` Errore: ${error.message}`, true);
            console.error('Effects error:', error);
        }
    }

    openConvert(trackId) {
        const track = this.tracks.find(t => t.id === trackId);
        if (!track) return;

        this.selectedTrackId = trackId;
        document.getElementById('convertFileName').textContent = track.name;
        
        // Se è audio, mostra opzione per video
        if (track.type === 'audio') {
            document.getElementById('audioToVideoOption').style.display = 'block';
        } else {
            document.getElementById('audioToVideoOption').style.display = 'none';
            document.getElementById('audioToVideoMode').value = 'none';
        }
        
        this.updateConvertOptions();
        document.getElementById('convertDialog').showModal();
    }

    updateConvertOptions() {
        const track = this.tracks.find(t => t.id === this.selectedTrackId);
        const videoMode = document.getElementById('audioToVideoMode').value;
        const formatSelect = document.getElementById('convertFormat');
        const imageUploadSection = document.getElementById('imageUploadSection');
        const videoUploadSection = document.getElementById('videoUploadSection');
        const slideshowOptions = document.getElementById('slideshowOptions');
        const videoMergeOptions = document.getElementById('videoMergeOptions');
        
        // Reset display
        imageUploadSection.style.display = 'none';
        videoUploadSection.style.display = 'none';
        slideshowOptions.style.display = 'none';
        videoMergeOptions.style.display = 'none';
        
        if (videoMode === 'static' || videoMode === 'slideshow' || videoMode === 'background') {
            // Mostra solo formati video
            formatSelect.innerHTML = `
                <option value="mp4">MP4</option>
                <option value="mkv">MKV</option>
                <option value="avi">AVI</option>
                <option value="mov">MOV</option>
            `;
            
            if (videoMode === 'static') {
                imageUploadSection.style.display = 'block';
                const imageInput = document.getElementById('imageFileInput');
                imageInput.removeAttribute('multiple');
                
            } else if (videoMode === 'slideshow') {
                imageUploadSection.style.display = 'block';
                slideshowOptions.style.display = 'block';
                const imageInput = document.getElementById('imageFileInput');
                imageInput.setAttribute('multiple', '');
                
            } else if (videoMode === 'background') {
                videoUploadSection.style.display = 'block';
                videoMergeOptions.style.display = 'block';
            }
        } else {
            // Conversione normale
            if (track.type === 'audio') {
                formatSelect.innerHTML = `
                    <option value="mp3">MP3</option>
                    <option value="wav">WAV</option>
                    <option value="flac">FLAC</option>
                    <option value="m4a">M4A</option>
                `;
            } else {
                formatSelect.innerHTML = `
                    <option value="mp4">MP4</option>
                    <option value="mkv">MKV</option>
                    <option value="avi">AVI</option>
                    <option value="mov">MOV</option>
                    <option value="mp3">MP3 (solo audio)</option>
                    <option value="wav">WAV (solo audio)</option>
                `;
            }
        }
    }

    async convertFile() {
        const track = this.tracks.find(t => t.id === this.selectedTrackId);
        if (!track) return;

        const format = document.getElementById('convertFormat').value;
        const videoMode = document.getElementById('audioToVideoMode')?.value;
        
        document.getElementById('convertDialog').close();

        try {
            if (videoMode === 'static' || videoMode === 'slideshow' || videoMode === 'background') {
                const formData = new FormData();
                
                // Recupera file audio dal server
                const audioBlob = await this.getFileBlob(track.filePath);
                formData.append('audio', audioBlob, track.name);
                formData.append('format', format);
                
                if (videoMode === 'background') {
                    // VIDEO BACKGROUND
                    const videoInput = document.getElementById('videoFileInput');
                    if (!videoInput.files || videoInput.files.length === 0) {
                        this.updateStatus('Errore: Seleziona almeno un video', true);
                        return;
                    }

                    this.showProgress(track.id, `Unione audio con ${videoInput.files.length} video...`);
                    
                    for (let i = 0; i < videoInput.files.length; i++) {
                        formData.append('videos', videoInput.files[i]);
                    }
                    
                    const videoMergeMode = document.getElementById('videoMergeMode').value || 'loop';
                    formData.append('videoMode', videoMergeMode);
                    formData.append('replaceAudio', 'true');

                    const response = await fetch(`${API_URL}/audio-video-merge`, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) throw new Error('Merge fallito');

                    const data = await response.json();
                    if (!data.success) throw new Error(data.error);

                    this.hideProgress(track.id);
                    this.updateStatus(`Video con audio creato! Scarico...`);

                    const newName = track.name.replace(/\.[^.]+$/, `_video.${format}`);
                    this.downloadFile(data.outputId, newName);
                    
                } else if (videoMode === 'slideshow') {
                    // SLIDESHOW
                    const imageInput = document.getElementById('imageFileInput');
                    if (!imageInput.files || imageInput.files.length === 0) {
                        this.updateStatus('Errore: Seleziona almeno un\'immagine', true);
                        return;
                    }

                    this.showProgress(track.id, `Creazione slideshow con ${imageInput.files.length} immagini...`);
                    
                    for (let i = 0; i < imageInput.files.length; i++) {
                        formData.append('images', imageInput.files[i]);
                    }
                    
                    const imageDuration = document.getElementById('imageDuration').value || 5;
                    const transition = document.getElementById('transitionType').value || 'fade';
                    formData.append('imageDuration', imageDuration);
                    formData.append('transition', transition);

                    const response = await fetch(`${API_URL}/audio-to-video-slideshow`, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) throw new Error('Conversione fallita');

                    const data = await response.json();
                    if (!data.success) throw new Error(data.error);

                    this.hideProgress(track.id);
                    this.updateStatus(`Slideshow creato! Scarico...`);

                    const newName = track.name.replace(/\.[^.]+$/, `_slideshow.${format}`);
                    this.downloadFile(data.outputId, newName);
                    
                } else {
                    // IMMAGINE STATICA
                    const imageInput = document.getElementById('imageFileInput');
                    if (!imageInput.files || imageInput.files.length === 0) {
                        this.updateStatus('Errore: Seleziona un\'immagine', true);
                        return;
                    }

                    this.showProgress(track.id, `Creazione video con immagine...`);
                    
                    formData.append('image', imageInput.files[0]);

                    const response = await fetch(`${API_URL}/audio-to-video`, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) throw new Error('Conversione fallita');

                    const data = await response.json();
                    if (!data.success) throw new Error(data.error);

                    this.hideProgress(track.id);
                    this.updateStatus(`Convertito in video ${format.toUpperCase()}! Scarico...`);

                    const newName = track.name.replace(/\.[^.]+$/, `.${format}`);
                    this.downloadFile(data.outputId, newName);
                }

            } else {
                // CONVERSIONE NORMALE
                this.showProgress(track.id, `Conversione in ${format.toUpperCase()}...`);

                const response = await fetch(`${API_URL}/convert`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filePath: track.filePath,
                        format,
                    }),
                });

                if (!response.ok) throw new Error('Conversione fallita');

                const data = await response.json();
                if (!data.success) throw new Error(data.error);

                this.hideProgress(track.id);
                this.updateStatus(`Convertito in ${format.toUpperCase()}! Scarico...`);

                const newName = track.name.replace(/\.[^.]+$/, `.${format}`);
                this.downloadFile(data.outputId, newName);
            }

        } catch (error) {
            this.hideProgress(track.id);
            this.updateStatus(`Errore: ${error.message}`, true);
            console.error('Convert error:', error);
        }
    }

    async getFileBlob(filePath) {
        const response = await fetch(`${API_URL}/file-download/${encodeURIComponent(filePath)}`);
        if (!response.ok) throw new Error('File non trovato sul server');
        return await response.blob();
    }

    downloadFile(outputId, filename) {
        const downloadUrl = `${API_URL}/download/${outputId}`;
        
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        this.updateStatus(' Download avviato!');
    }

    showProgress(trackId, message) {
        const container = document.getElementById(`progress-${trackId}`);
        const text = document.getElementById(`progress-text-${trackId}`);
        if (container && text) {
            container.style.display = 'block';
            text.textContent = message;
        }
    }

    hideProgress(trackId) {
        const container = document.getElementById(`progress-${trackId}`);
        if (container) {
            container.style.display = 'none';
        }
    }

    updateDisplay() {
        const maxDuration = Math.max(...this.tracks.map(t => t.duration || 0), 300);
        const percent = (this.cursorPosition / maxDuration) * 100;
        document.getElementById('timelineCursor').style.left = `${percent}%`;

        document.getElementById('currentTime').textContent = this.formatTime(this.cursorPosition);
        document.getElementById('duration').textContent = this.formatTime(maxDuration);
    }

    updateStatus(message, isError = false) {
        const statusEl = document.getElementById('statusText');
        statusEl.textContent = message;
        statusEl.style.color = isError ? '#f85149' : '#c9d1d9';
        
        const announcer = document.getElementById('statusAnnouncer');
        announcer.textContent = message;
    }

    formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        const ms = Math.floor((seconds % 1) * 1000);
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(3, '0')}`;
    }

    formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
}

// Inizializza app
const app = new VideoEditorWeb();
window.app = app;

console.log(' Video Editor Web - Versione Completa');
console.log('API URL:', API_URL);
console.log(' Storage locale - niente cloud');

</script>
</body>
</html>